{% extends 'plantilla.html' %}

{% block contenido %}

<div style="margin:auto; width:50%; padding:20px; border:1px solid #ccc;">
    <h2 style="text-align:center;">Editar Curso</h2>
    <br>

    <!-- Mostrar errores generales -->
    {% if messages %}
        {% for message in messages %}
            {% if message.tags == 'error' %}
                <div class="alert alert-danger alert-dismissible fade show">
                    <i class="fas fa-exclamation-circle"></i> {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% elif message.tags == 'success' %}
                <div class="alert alert-success alert-dismissible fade show">
                    <i class="fas fa-check-circle"></i> {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endif %}
        {% endfor %}
    {% endif %}

    <form method="post" id="frm_editar_curso">
        {% csrf_token %}

        <!-- Campo NOMBRE DEL CURSO -->
        <div class="mb-3">
            <label for="nombre" class="form-label"><b>Nombre del curso:</b></label>
            <input type="text" 
                   name="nombre" 
                   id="nombre"
                   class="form-control"
                   value="{{ curso.nombre }}">
            
            <!-- Mensaje de error -->
            <div class="invalid-feedback" style="display: none;"></div>
        </div>

        <!-- Campo ÁREA -->
        <div class="mb-3">
            <label for="area" class="form-label"><b>Área:</b></label>
            <select name="area" 
                    id="area" 
                    class="form-control">
                <option value="">-- Seleccione un área --</option>
                <option value="TEC" {% if curso.area == 'TEC' %}selected{% endif %}>Tecnología</option>
                <option value="ADM" {% if curso.area == 'ADM' %}selected{% endif %}>Administración</option>
                <option value="IDI" {% if curso.area == 'IDI' %}selected{% endif %}>Idiomas</option>
            </select>
            
            <!-- Mensaje de error -->
            <div class="invalid-feedback" style="display: none;"></div>
        </div>

        <!-- Campo DURACIÓN (horas) -->
        <div class="mb-3">
            <label for="duracion_horas" class="form-label"><b>Duración (horas):</b></label>
            <input type="text" 
                   name="duracion_horas" 
                   id="duracion_horas"
                   class="form-control"
                   value="{{ curso.duracion_horas }}">
            
            <!-- Mensaje de error -->
            <div class="invalid-feedback" style="display: none;"></div>
        </div>

        <!-- Campo CUPO MÁXIMO -->
        <div class="mb-3">
            <label for="cupo_maximo" class="form-label"><b>Cupo máximo:</b></label>
            <input type="text" 
                   name="cupo_maximo" 
                   id="cupo_maximo"
                   class="form-control"
                   value="{{ curso.cupo_maximo }}">
            
            <!-- Mensaje de error -->
            <div class="invalid-feedback" style="display: none;"></div>
        </div>

        <!-- Campo INSTRUCTOR -->
        <div class="mb-3">
            <label for="instructor" class="form-label"><b>Instructor:</b></label>
            <select name="instructor" 
                    id="instructor" 
                    class="form-control">
                <option value="">-- Seleccione un Instructor --</option>
                {% for i in instructores %}
                    <option value="{{ i.id }}" {% if curso.instructor.id == i.id %}selected{% endif %}>
                        {{ i.nombre }} {{ i.apellido }}
                    </option>
                {% endfor %}
            </select>
            
            <!-- Mensaje de error -->
            <div class="invalid-feedback" style="display: none;"></div>
        </div>

        <!-- Campo ESTADO -->
        <div class="mb-3">
            <label for="estado" class="form-label"><b>Estado:</b></label>
            <select name="estado" 
                    id="estado" 
                    class="form-control">
                <option value="">-- Seleccione un estado --</option>
                <option value="ACT" {% if curso.estado == 'ACT' %}selected{% endif %}>Activo</option>
                <option value="INA" {% if curso.estado == 'INA' %}selected{% endif %}>Inactivo</option>
            </select>
            
            <!-- Mensaje de error -->
            <div class="invalid-feedback" style="display: none;"></div>
        </div>

        <div style="text-align:center;">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i> Actualizar
            </button>
            <a href="{% url 'index' %}" class="btn btn-danger">
                <i class="fas fa-times"></i> Cancelar
            </a>
        </div>
    </form>
</div>

<!-- SweetAlert para confirmaciones -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
$(document).ready(function(){
    // Agregar reglas personalizadas
    
    // Regla para solo letras, números, espacios y guiones
    $.validator.addMethod("alphanumericspace", function(value, element) {
        return this.optional(element) || /^[A-Za-zÁÉÍÓÚáéíóúÑñ0-9\s\-]+$/.test(value);
    }, "Solo letras, números, espacios y guiones");
    
    // Regla para solo números enteros
    $.validator.addMethod("positiveinteger", function(value, element) {
        return this.optional(element) || /^[1-9][0-9]*$/.test(value);
    }, "Solo números enteros positivos");
    
    // Configurar validación del formulario
    $("#frm_editar_curso").validate({
        rules: {
            nombre: {
                required: true,
                maxlength: 100,
                alphanumericspace: true
            },
            area: {
                required: true
            },
            duracion_horas: {
                required: true,
                digits: true,
                min: 1,
                max: 1000
            },
            cupo_maximo: {
                required: true,
                digits: true,
                min: 1,
                max: 1000
            },
            instructor: {
                required: true
            },
            estado: {
                required: true
            }
        },
        messages: {
            nombre: {
                required: "El nombre del curso es requerido",
                maxlength: "Máximo 100 caracteres",
                alphanumericspace: "Solo se permiten letras, números, espacios y guiones"
            },
            area: {
                required: "Debe seleccionar un área"
            },
            duracion_horas: {
                required: "La duración es requerida",
                digits: "Solo se permiten números enteros",
                min: "Mínimo 1 hora",
                max: "Máximo 1000 horas"
            },
            cupo_maximo: {
                required: "El cupo máximo es requerido",
                digits: "Solo se permiten números enteros",
                min: "Mínimo 1 estudiante",
                max: "Máximo 1000 estudiantes"
            },
            instructor: {
                required: "Debe seleccionar un instructor"
            },
            estado: {
                required: "Debe seleccionar un estado"
            }
        },
        errorElement: 'div',
        errorClass: 'invalid-feedback',
        errorPlacement: function(error, element) {
            // Colocar el mensaje de error después del campo
            error.insertAfter(element);
            error.css('display', 'block');
        },
        highlight: function(element) {
            $(element).addClass('is-invalid');
        },
        unhighlight: function(element) {
            $(element).removeClass('is-invalid');
        },
        submitHandler: function(form) {
            // Mostrar confirmación antes de enviar
            Swal.fire({
                title: '¿Actualizar curso?',
                text: "¿Está seguro de guardar los cambios en este curso?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, actualizar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Enviar formulario
                    form.submit();
                }
            });
            
            return false; // Prevenir envío normal
        },
        invalidHandler: function(event, validator) {
            // Mostrar mensaje de error general
            Swal.fire({
                icon: 'error',
                title: 'Error de validación',
                text: 'Por favor corrija los errores en el formulario',
                confirmButtonText: 'Aceptar'
            });
            
            // Scroll al primer error
            const primerError = document.querySelector('.is-invalid');
            if (primerError) {
                primerError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });
    
    // Validación en tiempo real para campos específicos
    
    // Solo números para duración
    $('#duracion_horas').on('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '');
        
        // Limitar a 4 dígitos (para máximo 1000)
        if (this.value.length > 4) {
            this.value = this.value.slice(0, 4);
        }
        
        // No permitir 0 como primer dígito
        if (this.value.length > 1 && this.value.charAt(0) === '0') {
            this.value = this.value.substring(1);
        }
        
        // Si está vacío y luego escriben 0, convertirlo a 1
        if (this.value === '0') {
            this.value = '1';
        }
    });
    
    // Solo números para cupo
    $('#cupo_maximo').on('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '');
        
        // Limitar a 4 dígitos (para máximo 1000)
        if (this.value.length > 4) {
            this.value = this.value.slice(0, 4);
        }
        
        // No permitir 0 como primer dígito
        if (this.value.length > 1 && this.value.charAt(0) === '0') {
            this.value = this.value.substring(1);
        }
        
        // Si está vacío y luego escriben 0, convertirlo a 1
        if (this.value === '0') {
            this.value = '1';
        }
    });
    
    // Validar nombre en tiempo real
    $('#nombre').on('input', function() {
        // Solo letras, números, espacios y guiones
        this.value = this.value.replace(/[^A-Za-zÁÉÍÓÚáéíóúÑñ0-9\s\-]/g, '');
        
        // Limitar a 100 caracteres
        if (this.value.length > 100) {
            this.value = this.value.slice(0, 100);
        }
    });
    
    // Validar que los select no estén vacíos
    $('#area, #instructor, #estado').on('change', function() {
        if (this.value === '') {
            $(this).addClass('is-invalid');
        } else {
            $(this).removeClass('is-invalid');
        }
    });
});
</script>

<!-- Estilos adicionales para jQuery Validate -->
<style>
.form-control.is-invalid {
    border-color: #dc3545;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.form-control.is-invalid:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
}

select.form-control.is-invalid {
    background-position: right 1.75rem center;
    padding-right: 2.5rem;
}

.invalid-feedback {
    display: block;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: #dc3545;
}

.btn {
    padding: 8px 20px;
    margin: 0 5px;
}

.btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.btn-danger {
    background-color: #dc3545;
    border-color: #dc3545;
}
</style>

{% endblock %}