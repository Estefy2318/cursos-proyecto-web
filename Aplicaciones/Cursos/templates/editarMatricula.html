{% extends './plantilla.html' %}

{% block contenido %}

<div style="margin:auto; width:50%; padding:20px; border:1px solid #ccc;">
    <h2 style="text-align:center;">Editar Matricula</h2>
    <br>

    <!-- Mostrar mensajes de Django -->
    {% if messages %}
        {% for message in messages %}
            {% if message.tags == 'error' %}
                <div class="alert alert-danger alert-dismissible fade show">
                    <i class="fas fa-exclamation-circle"></i> {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% elif message.tags == 'success' %}
                <div class="alert alert-success alert-dismissible fade show">
                    <i class="fas fa-check-circle"></i> {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endif %}
        {% endfor %}
    {% endif %}

    {% if error %}
        <div class="alert alert-danger">
            {{ error }}
        </div>
    {% endif %}

    <form action="{% url 'editarMatricula' matricula.id %}" method="post" id="frm_editar_matricula">
        {% csrf_token %}

        <!-- Campo NOMBRE DEL ESTUDIANTE -->
        <div class="mb-3">
            <label for="nombre_estudiante" class="form-label"><b>Nombre del estudiante:</b></label>
            <input type="text"
                   name="nombre_estudiante"
                   id="nombre_estudiante"
                   class="form-control"
                   value="{{ matricula.nombre_estudiante }}"
                   placeholder="Ingrese el nombre del estudiante">
            
            <!-- Mensaje de error -->
            <div class="invalid-feedback" style="display: none;"></div>
        </div>

        <!-- Campo DOCUMENTO DE IDENTIDAD -->
        <div class="mb-3">
            <label for="documento_identidad" class="form-label"><b>Documento de identidad:</b></label>
            <input type="text"
                   name="documento_identidad"
                   id="documento_identidad"
                   class="form-control"
                   value="{{ matricula.documento_identidad }}"
                   placeholder="Ingrese el documento (10 dígitos)">
            
            <!-- Mensaje de error -->
            <div class="invalid-feedback" style="display: none;"></div>
        </div>

        <!-- Campo FECHA DE MATRÍCULA -->
        <div class="mb-3">
            <label for="fecha_matricula" class="form-label"><b>Fecha de matricula:</b></label>
            <input type="date"
                   name="fecha_matricula"
                   id="fecha_matricula"
                   class="form-control"
                   value="{{ matricula.fecha_matricula|date:'Y-m-d' }}"
                   max="{{ today|date:'Y-m-d' }}">
            
            <!-- Mensaje de error -->
            <div class="invalid-feedback" style="display: none;"></div>
        </div>

        <!-- Campo CURSO -->
        <div class="mb-3">
            <label for="curso" class="form-label"><b>Curso:</b></label>
            <select name="curso" 
                    id="curso" 
                    class="form-control">
                <option value="">-- Seleccione un curso --</option>
                {% for curso in cursos %}
                    <option value="{{ curso.id }}"
                        {% if curso.id == matricula.curso.id %}selected{% endif %}>
                        {{ curso.nombre }} (Cupos disponibles: {{ curso.cupo_maximo }})
                    </option>
                {% endfor %}
            </select>
            
            <!-- Mensaje de error -->
            <div class="invalid-feedback" style="display: none;"></div>
        </div>

        <!-- Campo INSTRUCTOR (AGREGADO) -->
        <div class="mb-3">
            <label for="instructor" class="form-label"><b>Instructor:</b></label>
            <select name="instructor" 
                    id="instructor" 
                    class="form-control">
                <option value="">-- Seleccione un instructor --</option>
                {% for instructor in instructores %}
                    <option value="{{ instructor.id }}"
                        {% if matricula.instructor and matricula.instructor.id == instructor.id %}selected{% endif %}>
                        {{ instructor.nombre }} {{ instructor.apellido }}
                    </option>
                {% endfor %}
            </select>
            
            <!-- Mensaje de error -->
            <div class="invalid-feedback" style="display: none;"></div>
        </div>

        <div style="text-align:center;">
            <button type="submit" class="btn btn-primary" style="padding:6px 20px;">
                <i class="fas fa-sync-alt"></i> Actualizar
            </button>
            <a href="{% url 'matriculas' %}" class="btn btn-danger" style="margin-left:10px;">
                <i class="fas fa-times"></i> Cancelar y volver
            </a>
        </div>
    </form>
</div>

<script>
$(document).ready(function(){
    // Agregar reglas personalizadas
    
    // Regla para solo letras y espacios
    $.validator.addMethod("lettersonly", function(value, element) {
        return this.optional(element) || /^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$/.test(value);
    }, "Solo se permiten letras y espacios");
    
    // Regla para documento de identidad (10 dígitos)
    $.validator.addMethod("documento10", function(value, element) {
        return this.optional(element) || /^[0-9]{10}$/.test(value);
    }, "Debe tener 10 dígitos numéricos");
    
    // Regla para fecha no futura
    $.validator.addMethod("nofutura", function(value, element) {
        if (!value) return true;
        
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        
        const fechaIngresada = new Date(value);
        
        return fechaIngresada <= hoy;
    }, "La fecha no puede ser futura");
    
    // Configurar validación del formulario
    $("#frm_editar_matricula").validate({
        rules: {
            nombre_estudiante: {
                required: true,
                lettersonly: true,
                maxlength: 100
            },
            documento_identidad: {
                required: true,
                documento10: true,
                digits: true
            },
            fecha_matricula: {
                required: true,
                date: true,
                nofutura: true
            },
            curso: {
                required: true
            },
            instructor: {
                required: true
            }
        },
        messages: {
            nombre_estudiante: {
                required: "El nombre del estudiante es requerido",
                lettersonly: "Solo se permiten letras y espacios",
                maxlength: "Máximo 100 caracteres"
            },
            documento_identidad: {
                required: "El documento de identidad es requerido",
                documento10: "Debe tener 10 dígitos numéricos",
                digits: "Solo se permiten números"
            },
            fecha_matricula: {
                required: "La fecha de matrícula es requerida",
                date: "Formato de fecha no válido",
                nofutura: "La fecha no puede ser futura"
            },
            curso: {
                required: "Debe seleccionar un curso"
            },
            instructor: {
                required: "Debe seleccionar un instructor"
            }
        },
        errorElement: 'div',
        errorClass: 'invalid-feedback',
        errorPlacement: function(error, element) {
            // Colocar el mensaje de error después del campo
            error.insertAfter(element);
            error.css('display', 'block');
        },
        highlight: function(element) {
            $(element).addClass('is-invalid');
        },
        unhighlight: function(element) {
            $(element).removeClass('is-invalid');
        },
        submitHandler: function(form) {
            // Mostrar confirmación antes de enviar
            Swal.fire({
                title: '¿Actualizar matrícula?',
                text: "¿Está seguro de guardar los cambios en esta matrícula?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, actualizar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Enviar formulario
                    form.submit();
                }
            });
            
            return false; // Prevenir envío normal
        },
        invalidHandler: function(event, validator) {
            // Mostrar mensaje de error general
            Swal.fire({
                icon: 'error',
                title: 'Error de validación',
                text: 'Por favor corrija los errores en el formulario',
                confirmButtonText: 'Aceptar'
            });
            
            // Scroll al primer error
            const primerError = document.querySelector('.is-invalid');
            if (primerError) {
                primerError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });
    
    // Validación en tiempo real para campos específicos
    
    // Solo letras para nombre del estudiante
    $('#nombre_estudiante').on('input', function() {
        this.value = this.value.replace(/[^A-Za-zÁÉÍÓÚáéíóúÑñ\s]/g, '');
        
        if (this.value.length > 100) {
            this.value = this.value.slice(0, 100);
        }
    });
    
    // Solo números para documento, máximo 10 dígitos
    $('#documento_identidad').on('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '');
        
        if (this.value.length > 10) {
            this.value = this.value.slice(0, 10);
        }
    });
    
    // Establecer fecha máxima como hoy
    const today = new Date().toISOString().split('T')[0];
    $('#fecha_matricula').attr('max', today);
    
    // Validar fecha seleccionada
    $('#fecha_matricula').on('change', function() {
        const fechaSeleccionada = new Date(this.value);
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        
        if (fechaSeleccionada > hoy) {
            $(this).addClass('is-invalid');
            $(this).next('.invalid-feedback').text('La fecha no puede ser futura').show();
        } else {
            $(this).removeClass('is-invalid');
            $(this).next('.invalid-feedback').hide();
        }
    });
    
    // Validar que los select no estén vacíos
    $('#curso, #instructor').on('change', function() {
        if (this.value === '') {
            $(this).addClass('is-invalid');
        } else {
            $(this).removeClass('is-invalid');
        }
    });
    
    // Inicializar validación de los selects
    if ($('#curso').val() === '') {
        $('#curso').addClass('is-invalid');
    }
    
    if ($('#instructor').val() === '') {
        $('#instructor').addClass('is-invalid');
    }
});
</script>

<style>
.form-control.is-invalid {
    border-color: #dc3545;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.form-control.is-invalid:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
}

select.form-control.is-invalid {
    background-position: right 1.75rem center;
    padding-right: 2.5rem;
}

.invalid-feedback {
    display: block;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: #dc3545;
}

.btn {
    padding: 8px 20px;
    margin: 0 5px;
}

.btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.btn-danger {
    background-color: #dc3545;
    border-color: #dc3545;
}
</style>

{% endblock %}