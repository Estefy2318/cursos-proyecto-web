{% extends './plantilla.html' %}

{% block contenido %}

<div style="margin:auto; width:50%; padding:20px; border:1px solid #ccc;">
    <h2 style="text-align:center;">Editar Instructor</h2>
    <br>

    <!-- Mostrar mensajes de Django -->
    {% if messages %}
        {% for message in messages %}
            {% if message.tags == 'error' %}
                <div class="alert alert-danger alert-dismissible fade show">
                    <i class="fas fa-exclamation-circle"></i> {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% elif message.tags == 'success' %}
                <div class="alert alert-success alert-dismissible fade show">
                    <i class="fas fa-check-circle"></i> {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endif %}
        {% endfor %}
    {% endif %}

    {% if error %}
        <div class="alert alert-danger">
            {{ error }}
        </div>
    {% endif %}

    <form action="{% url 'editarInstructor' instructor.id %}" method="post" enctype="multipart/form-data" id="frm_instructor">
        {% csrf_token %}

        <!-- Campo CÉDULA -->
        <div class="mb-3">
            <label for="cedula" class="form-label"><b>Cédula:</b></label>
            <input type="text" 
                   name="cedula" 
                   id="cedula"
                   class="form-control"
                   placeholder="Ingrese la cédula (10 dígitos)"
                   value="{{ instructor.cedula }}">
            
            <!-- Mensaje de error -->
            <div class="invalid-feedback" style="display: none;"></div>
        </div>

        <!-- Campo APELLIDO -->
        <div class="mb-3">
            <label for="apellido" class="form-label"><b>Apellido:</b></label>
            <input type="text" 
                   name="apellido" 
                   id="apellido"
                   class="form-control"
                   placeholder="Ingrese el apellido (solo letras)"
                   value="{{ instructor.apellido }}">
            
            <!-- Mensaje de error -->
            <div class="invalid-feedback" style="display: none;"></div>
        </div>

        <!-- Campo NOMBRE -->
        <div class="mb-3">
            <label for="nombre" class="form-label"><b>Nombre:</b></label>
            <input type="text" 
                   name="nombre" 
                   id="nombre"
                   class="form-control"
                   placeholder="Ingrese el nombre (solo letras)"
                   value="{{ instructor.nombre }}">
            
            <!-- Mensaje de error -->
            <div class="invalid-feedback" style="display: none;"></div>
        </div>

        <!-- Campo TITULACIÓN -->
        <div class="mb-3">
            <label for="titulacion" class="form-label"><b>Titulación:</b></label>
            <input type="text" 
                   name="titulacion" 
                   id="titulacion"
                   class="form-control"
                   placeholder="Ingrese la titulación"
                   value="{{ instructor.titulacion }}">
            
            <!-- Mensaje de error -->
            <div class="invalid-feedback" style="display: none;"></div>
        </div>

        <!-- Campo FOTO -->
        <div class="mb-3">
            <label for="imginstructor" class="form-label"><b>Foto:</b></label>
            
            {% if instructor.imginstructor %}
                <div style="margin-bottom: 10px;">
                    <img src="{{ instructor.imginstructor.url }}" 
                         width="100" 
                         class="rounded border"
                         id="foto-actual">
                    <div class="form-text text-muted mt-1">
                        <small>Foto actual. Suba una nueva si desea cambiarla.</small>
                    </div>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <small><i class="fas fa-info-circle"></i> No hay foto actual</small>
                </div>
            {% endif %}
            
            <input type="file" 
                   name="imginstructor" 
                   id="imginstructor"
                   class="form-control"
                   accept="image/*">
            
            <!-- Mensaje de ayuda -->
            <div class="form-text text-muted">
                <small>Formatos permitidos: JPG, PNG, GIF. Tamaño máximo: 2MB</small>
            </div>
            
            <!-- Mensaje de error -->
            <div class="invalid-feedback" style="display: none;"></div>
            
            <!-- Vista previa de nueva imagen -->
            <div id="vista-previa" class="mt-2" style="display: none;">
                <img id="preview-img" src="#" alt="Vista previa" 
                     style="max-width: 150px; max-height: 150px; border: 1px solid #ccc; padding: 5px;">
                <div class="form-text text-muted">
                    <small>Vista previa de la nueva imagen</small>
                </div>
            </div>
        </div>

        <div style="text-align:center;">
            <button type="submit" class="btn btn-primary" style="padding:6px 20px;">
                <i class="fas fa-sync-alt"></i> Actualizar
            </button>
            <a href="{% url 'listar_instructores' %}" class="btn btn-danger" style="margin-left:10px;">
                <i class="fas fa-times"></i> Cancelar y volver
            </a>
        </div>
    </form>
</div>

<!-- SweetAlert para confirmaciones -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
$(document).ready(function(){
    // Agregar reglas personalizadas
    
    // Regla para solo letras y espacios
    $.validator.addMethod("lettersonly", function(value, element) {
        return this.optional(element) || /^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$/.test(value);
    }, "Solo se permiten letras y espacios");
    
    // Regla para cédula (10 dígitos exactos)
    $.validator.addMethod("cedula10", function(value, element) {
        return this.optional(element) || /^[0-9]{10}$/.test(value);
    }, "Debe tener 10 dígitos numéricos");
    
    // Regla para validar imagen
    $.validator.addMethod("validimage", function(value, element) {
        if (element.files.length === 0) {
            return true; // No hay archivo, es opcional
        }
        
        const file = element.files[0];
        const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/jpg'];
        const maxSize = 2 * 1024 * 1024; // 2MB
        
        // Validar tipo
        if (!validTypes.includes(file.type)) {
            return false;
        }
        
        // Validar tamaño
        if (file.size > maxSize) {
            return false;
        }
        
        return true;
    }, "Formato no válido o tamaño mayor a 2MB");
    
    // Configurar validación del formulario
    $("#frm_instructor").validate({
        rules: {
            cedula: {
                required: true,
                cedula10: true,
                digits: true
            },
            apellido: {
                required: true,
                lettersonly: true,
                maxlength: 50
            },
            nombre: {
                required: true,
                lettersonly: true,
                maxlength: 50
            },
            titulacion: {
                required: true,
                maxlength: 100
            },
            imginstructor: {
                validimage: true
            }
        },
        messages: {
            cedula: {
                required: "La cédula es requerida",
                cedula10: "Debe tener exactamente 10 dígitos",
                digits: "Solo se permiten números"
            },
            apellido: {
                required: "El apellido es requerido",
                lettersonly: "Solo se permiten letras y espacios",
                maxlength: "Máximo 50 caracteres"
            },
            nombre: {
                required: "El nombre es requerido",
                lettersonly: "Solo se permiten letras y espacios",
                maxlength: "Máximo 50 caracteres"
            },
            titulacion: {
                required: "La titulación es requerida",
                maxlength: "Máximo 100 caracteres"
            },
            imginstructor: {
                validimage: "Formato no válido (JPG, PNG, GIF) o tamaño mayor a 2MB"
            }
        },
        errorElement: 'div',
        errorClass: 'invalid-feedback',
        errorPlacement: function(error, element) {
            // Colocar el mensaje de error después del campo
            error.insertAfter(element);
            error.css('display', 'block');
        },
        highlight: function(element) {
            $(element).addClass('is-invalid');
        },
        unhighlight: function(element) {
            $(element).removeClass('is-invalid');
        },
        submitHandler: function(form) {
            // Mostrar confirmación antes de enviar
            Swal.fire({
                title: '¿Actualizar instructor?',
                text: "¿Está seguro de guardar los cambios en este instructor?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, actualizar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Enviar formulario
                    form.submit();
                }
            });
            
            return false; // Prevenir envío normal
        },
        invalidHandler: function(event, validator) {
            // Mostrar mensaje de error general
            Swal.fire({
                icon: 'error',
                title: 'Error de validación',
                text: 'Por favor corrija los errores en el formulario',
                confirmButtonText: 'Aceptar'
            });
            
            // Scroll al primer error
            const primerError = document.querySelector('.is-invalid');
            if (primerError) {
                primerError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });
    
    // Validación en tiempo real para campos específicos
    
    // Solo números para cédula, máximo 10 dígitos
    $('#cedula').on('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '');
        
        if (this.value.length > 10) {
            this.value = this.value.slice(0, 10);
        }
    });
    
    // Solo letras para apellido
    $('#apellido').on('input', function() {
        this.value = this.value.replace(/[^A-Za-zÁÉÍÓÚáéíóúÑñ\s]/g, '');
        
        if (this.value.length > 50) {
            this.value = this.value.slice(0, 50);
        }
    });
    
    // Solo letras para nombre
    $('#nombre').on('input', function() {
        this.value = this.value.replace(/[^A-Za-zÁÉÍÓÚáéíóúÑñ\s]/g, '');
        
        if (this.value.length > 50) {
            this.value = this.value.slice(0, 50);
        }
    });
    
    // Limitar titulación a 100 caracteres
    $('#titulacion').on('input', function() {
        if (this.value.length > 100) {
            this.value = this.value.slice(0, 100);
        }
    });
    
    // Validar y mostrar vista previa de imagen
    $('#imginstructor').on('change', function() {
        const file = this.files[0];
        const vistaPrevia = $('#vista-previa');
        const previewImg = $('#preview-img');
        
        if (file) {
            // Validar tamaño (2MB máximo)
            if (file.size > 2 * 1024 * 1024) {
                $(this).addClass('is-invalid');
                $(this).next('.invalid-feedback').text('La imagen no debe superar los 2MB').show();
                this.value = '';
                vistaPrevia.hide();
                return;
            }
            
            // Validar tipo
            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/jpg'];
            if (!validTypes.includes(file.type)) {
                $(this).addClass('is-invalid');
                $(this).next('.invalid-feedback').text('Solo se permiten imágenes (JPG, PNG, GIF)').show();
                this.value = '';
                vistaPrevia.hide();
                return;
            }
            
            // Mostrar vista previa
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.attr('src', e.target.result);
                vistaPrevia.show();
            }
            reader.readAsDataURL(file);
            
            // Limpiar errores
            $(this).removeClass('is-invalid');
            $(this).next('.invalid-feedback').hide();
        } else {
            vistaPrevia.hide();
        }
    });
});
</script>

<!-- Estilos adicionales -->
<style>
.form-control.is-invalid {
    border-color: #dc3545;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.form-control.is-invalid:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
}

.invalid-feedback {
    display: block;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: #dc3545;
}

#foto-actual {
    border: 2px solid #dee2e6;
    padding: 3px;
    background-color: #f8f9fa;
}

#preview-img {
    border: 2px solid #0d6efd;
    padding: 3px;
    background-color: #fff;
}
</style>

{% endblock %}