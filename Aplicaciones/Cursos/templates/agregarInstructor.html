{% extends './plantilla.html' %}

{% block contenido %}

<div style="margin:auto; width:50%; padding:20px; border:1px solid #ccc;">
    <h2 style="text-align:center;">Registrar Instructor</h2>
    <br>

    {% if error %}
        <div class="alert alert-danger">
            {{ error }}
        </div>
    {% endif %}

    <!-- Mostrar errores generales del formulario -->
    {% if messages %}
        {% for message in messages %}
            {% if message.tags == 'error' %}
                <div class="alert alert-danger alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endif %}
        {% endfor %}
    {% endif %}

    <form action="{% url 'agregarInstructor' %}" method="post" enctype="multipart/form-data" id="frm_instructor">
        {% csrf_token %}

        <!-- Campo CÉDULA -->
        <div class="mb-3">
            <label for="cedula" class="form-label"><b>Cédula:</b></label>
            <input type="text" 
                   name="cedula" 
                   id="cedula"
                   class="form-control"
                   placeholder="Ingrese la cédula (10 dígitos)"
                   maxlength="10"
                   pattern="[0-9]{10}"
                   title="La cédula debe tener exactamente 10 dígitos numéricos"
                   value="{{ request.POST.cedula|default:'' }}"
                   required>
            
            <!-- Mensaje de ayuda -->
            <div class="form-text text-muted">
                <small>Debe tener exactamente 10 dígitos numéricos</small>
            </div>
            
            <!-- Mensaje de error (aparece cuando hay validación) -->
            <div id="cedula-error" class="text-danger small mt-1" style="display: none;"></div>
        </div>

        <!-- Campo APELLIDO -->
        <div class="mb-3">
            <label for="apellido" class="form-label"><b>Apellido:</b></label>
            <input type="text" 
                   name="apellido" 
                   id="apellido"
                   class="form-control"
                   placeholder="Ingrese el apellido (solo letras)"
                   pattern="[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+"
                   title="Solo se permiten letras y espacios"
                   value="{{ request.POST.apellido|default:'' }}"
                   required>
            
            <!-- Mensaje de ayuda -->
            <div class="form-text text-muted">
                <small>Solo se permiten letras y espacios</small>
            </div>
            
            <!-- Mensaje de error -->
            <div id="apellido-error" class="text-danger small mt-1" style="display: none;"></div>
        </div>

        <!-- Campo NOMBRE -->
        <div class="mb-3">
            <label for="nombre" class="form-label"><b>Nombre:</b></label>
            <input type="text" 
                   name="nombre" 
                   id="nombre"
                   class="form-control"
                   placeholder="Ingrese el nombre (solo letras)"
                   pattern="[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+"
                   title="Solo se permiten letras y espacios"
                   value="{{ request.POST.nombre|default:'' }}"
                   required>
            
            <!-- Mensaje de ayuda -->
            <div class="form-text text-muted">
                <small>Solo se permiten letras y espacios</small>
            </div>
            
            <!-- Mensaje de error -->
            <div id="nombre-error" class="text-danger small mt-1" style="display: none;"></div>
        </div>

        <!-- Campo TITULACIÓN -->
        <div class="mb-3">
            <label for="titulacion" class="form-label"><b>Titulación:</b></label>
            <input type="text" 
                   name="titulacion" 
                   id="titulacion"
                   class="form-control"
                   placeholder="Ingrese la titulación"
                   value="{{ request.POST.titulacion|default:'' }}"
                   required>
            
            <!-- Mensaje de ayuda -->
            <div class="form-text text-muted">
                <small>Ej: Ingeniero en Sistemas, Licenciado en Educación, etc.</small>
            </div>
            
            <!-- Mensaje de error -->
            <div id="titulacion-error" class="text-danger small mt-1" style="display: none;"></div>
        </div>

        <!-- Campo FOTO -->
        <div class="mb-3">
            <label for="imginstructor" class="form-label"><b>Foto:</b></label>
            <input type="file" 
                   name="imginstructor" 
                   id="imginstructor"
                   class="form-control"
                   accept="image/*"
                   onchange="validarImagen(this)">
            
            <!-- Mensaje de ayuda -->
            <div class="form-text text-muted">
                <small>Formatos permitidos: JPG, PNG, GIF. Tamaño máximo: 2MB</small>
            </div>
            
            <!-- Mensaje de error -->
            <div id="imagen-error" class="text-danger small mt-1" style="display: none;"></div>
            
            <!-- Vista previa de la imagen -->
            <div id="vista-previa" class="mt-2" style="display: none;">
                <img id="preview-img" src="#" alt="Vista previa" style="max-width: 150px; max-height: 150px; border: 1px solid #ccc; padding: 5px;">
            </div>
        </div>

        <div style="text-align:center;">
            <button type="submit" class="btn btn-primary" style="padding:6px 20px;">
                <i class="fas fa-save"></i> Guardar
            </button>
            <a href="{% url 'listar_instructores' %}" class="btn btn-danger" style="margin-left:10px;">
                <i class="fas fa-times"></i> Cancelar y volver
            </a>
        </div>
    </form>
</div>

<!-- SweetAlert para confirmaciones -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// Función para mostrar error debajo del campo
function mostrarError(campoId, mensaje) {
    const errorDiv = document.getElementById(campoId + '-error');
    const input = document.getElementById(campoId);
    
    if (errorDiv && input) {
        errorDiv.textContent = mensaje;
        errorDiv.style.display = 'block';
        input.classList.add('is-invalid');
    }
}

// Función para limpiar error
function limpiarError(campoId) {
    const errorDiv = document.getElementById(campoId + '-error');
    const input = document.getElementById(campoId);
    
    if (errorDiv && input) {
        errorDiv.textContent = '';
        errorDiv.style.display = 'none';
        input.classList.remove('is-invalid');
    }
}

// Función para validar imagen
function validarImagen(input) {
    const errorDiv = document.getElementById('imagen-error');
    const vistaPrevia = document.getElementById('vista-previa');
    const previewImg = document.getElementById('preview-img');
    
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const fileSize = file.size / 1024 / 1024; // Convertir a MB
        const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/jpg'];
        
        // Validar tipo de archivo
        if (!validTypes.includes(file.type)) {
            mostrarError('imagen', 'Solo se permiten imágenes (JPG, PNG, GIF)');
            input.value = '';
            vistaPrevia.style.display = 'none';
            return false;
        }
        
        // Validar tamaño (máximo 2MB)
        if (fileSize > 2) {
            mostrarError('imagen', 'La imagen no debe superar los 2MB');
            input.value = '';
            vistaPrevia.style.display = 'none';
            return false;
        }
        
        // Mostrar vista previa
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            vistaPrevia.style.display = 'block';
        }
        reader.readAsDataURL(file);
        
        limpiarError('imagen');
        return true;
    }
    
    vistaPrevia.style.display = 'none';
    return false;
}

// Validación en tiempo real para cada campo
document.addEventListener('DOMContentLoaded', function() {
    // Validación CÉDULA - Solo números, máximo 10 dígitos
    document.getElementById('cedula').addEventListener('input', function() {
        // Eliminar cualquier caracter que no sea número
        this.value = this.value.replace(/[^0-9]/g, '');
        
        // Limitar a 10 dígitos
        if (this.value.length > 10) {
            this.value = this.value.slice(0, 10);
        }
        
        // Validar en tiempo real
        if (this.value.length === 10) {
            limpiarError('cedula');
        } else if (this.value.length > 0) {
            mostrarError('cedula', `Debe tener 10 dígitos. Actual: ${this.value.length}`);
        } else {
            limpiarError('cedula');
        }
    });
    
    // Validación APELLIDO - Solo letras y espacios
    document.getElementById('apellido').addEventListener('input', function() {
        const regex = /[^A-Za-zÁÉÍÓÚáéíóúÑñ\s]/g;
        if (regex.test(this.value)) {
            this.value = this.value.replace(regex, '');
            mostrarError('apellido', 'Solo se permiten letras y espacios');
        } else {
            limpiarError('apellido');
        }
    });
    
    // Validación NOMBRE - Solo letras y espacios
    document.getElementById('nombre').addEventListener('input', function() {
        const regex = /[^A-Za-zÁÉÍÓÚáéíóúÑñ\s]/g;
        if (regex.test(this.value)) {
            this.value = this.value.replace(regex, '');
            mostrarError('nombre', 'Solo se permiten letras y espacios');
        } else {
            limpiarError('nombre');
        }
    });
    
    // Validación TITULACIÓN - Limitar caracteres
    document.getElementById('titulacion').addEventListener('input', function() {
        if (this.value.length > 100) {
            this.value = this.value.slice(0, 100);
            mostrarError('titulacion', 'Máximo 100 caracteres');
        } else {
            limpiarError('titulacion');
        }
    });
    
    // Validación antes de enviar el formulario
    document.getElementById('frm_instructor').addEventListener('submit', function(e) {
        e.preventDefault();
        
        let valid = true;
        
        // Validar CÉDULA
        const cedula = document.getElementById('cedula').value;
        if (cedula.length !== 10) {
            mostrarError('cedula', 'La cédula debe tener exactamente 10 dígitos');
            valid = false;
        } else if (!/^[0-9]{10}$/.test(cedula)) {
            mostrarError('cedula', 'La cédula solo puede contener números');
            valid = false;
        }
        
        // Validar APELLIDO
        const apellido = document.getElementById('apellido').value;
        if (!/^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$/.test(apellido)) {
            mostrarError('apellido', 'El apellido solo puede contener letras y espacios');
            valid = false;
        }
        
        // Validar NOMBRE
        const nombre = document.getElementById('nombre').value;
        if (!/^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$/.test(nombre)) {
            mostrarError('nombre', 'El nombre solo puede contener letras y espacios');
            valid = false;
        }
        
        // Validar TITULACIÓN
        const titulacion = document.getElementById('titulacion').value;
        if (titulacion.trim().length === 0) {
            mostrarError('titulacion', 'La titulación es requerida');
            valid = false;
        }
        
        // Si todo es válido, mostrar confirmación
        if (valid) {
            Swal.fire({
                title: '¿Guardar instructor?',
                text: "¿Está seguro de registrar este instructor?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, guardar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Enviar formulario
                    this.submit();
                }
            });
        } else {
            // Mostrar mensaje de error general
            Swal.fire({
                icon: 'error',
                title: 'Error de validación',
                text: 'Por favor corrija los errores en el formulario',
                confirmButtonText: 'Aceptar'
            });
            
            // Scroll al primer error
            const primerError = document.querySelector('.is-invalid');
            if (primerError) {
                primerError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });
});

// También mantener la validación con jQuery Validate para compatibilidad
$(document).ready(function(){
    $("#frm_instructor").validate({
        rules: {
            cedula: {
                required: true,
                minlength: 10,
                maxlength: 10,
                digits: true
            },
            apellido: {
                required: true,
                lettersonly: true
            },
            nombre: {
                required: true,
                lettersonly: true
            },
            titulacion: {
                required: true
            }
        },
        messages: {
            cedula: {
                required: "Ingrese la cédula",
                minlength: "La cédula debe tener 10 dígitos",
                maxlength: "La cédula debe tener 10 dígitos",
                digits: "La cédula solo puede contener números"
            },
            apellido: {
                required: "Ingrese el apellido",
                lettersonly: "El apellido solo puede contener letras"
            },
            nombre: {
                required: "Ingrese el nombre",
                lettersonly: "El nombre solo puede contener letras"
            },
            titulacion: {
                required: "Ingrese la titulación"
            }
        },
        errorElement: 'div',
        errorClass: 'text-danger small mt-1',
        errorPlacement: function(error, element) {
            // Colocar el mensaje de error después del campo
            error.insertAfter(element);
        },
        highlight: function(element) {
            $(element).addClass('is-invalid');
        },
        unhighlight: function(element) {
            $(element).removeClass('is-invalid');
        }
    });
    
    // Agregar regla personalizada para solo letras
    $.validator.addMethod("lettersonly", function(value, element) {
        return this.optional(element) || /^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$/.test(value);
    });
});
</script>
<style>
.form-control.is-invalid {
    border-color: #dc3545;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.form-control.is-invalid:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
}

select.form-control.is-invalid {
    background-position: right 1.75rem center;
    padding-right: 2.5rem;
}

.invalid-feedback {
    display: block;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: #dc3545;
}
</style>


{% endblock %}